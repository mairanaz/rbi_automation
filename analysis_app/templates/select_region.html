{% extends 'base.html' %}
{% load static %}
{% block title %}Select Region{% endblock %}

{% block content %}
<div class="container py-4">
    <h3 class="mb-3">{{ step_label }}</h3>
    <p class="text-muted">File: {{ analysis.original_filename }} · Page {{ page_number }}</p>

    <div class="row">
        <div class="col-md-4">
            <p><strong>Instruction:</strong></p>
            <ol class="small">
                <li>Click & drag on the page preview to draw a rectangle.</li>
                <li>Click <b>Confirm Selection</b> after you're satisfied.</li>
            </ol>
            <p class="small text-muted mb-1">Selection (normalized 0–1):</p>
            <p class="small">
                x1: <span id="coord-x1">-</span>,
                y1: <span id="coord-y1">-</span><br>
                x2: <span id="coord-x2">-</span>,
                y2: <span id="coord-y2">-</span>
            </p>
        </div>

        <div class="col-md-8">
            <div class="d-flex justify-content-between align-items-center mb-2">
        <div class="small text-muted">
            Page {{ page_number }}{% if total_pages %} of {{ total_pages }}{% endif %}
        </div>
        <div class="btn-group btn-group-sm" role="group">
            {% if prev_page_url %}
                <a href="{{ prev_page_url }}" class="btn btn-outline-secondary">
                    <i class="bi bi-chevron-left"></i> Previous
                </a>
            {% else %}
                <button class="btn btn-outline-secondary" disabled>
                    <i class="bi bi-chevron-left"></i> Previous
                </button>
            {% endif %}

            {% if next_page_url %}
                <a href="{{ next_page_url }}" class="btn btn-outline-secondary">
                    Next <i class="bi bi-chevron-right"></i>
                </a>
            {% else %}
                <button class="btn btn-outline-secondary" disabled>
                    Next <i class="bi bi-chevron-right"></i>
                </button>
            {% endif %}
        </div>
    </div>
            <div id="viewer-container" class="position-relative d-inline-block border">
             
                <img id="pdf-image"
                     src="{{ page_image_url }}"
                     class="img-fluid"
                     draggable="false"
                     alt="PDF Page {{ page_number }}">

                
                <div id="selection-rect"
                     class="position-absolute border border-primary bg-primary bg-opacity-25 d-none">
                </div>
            </div>
            <p class="small text-muted mt-2 mb-0">
                Tip: drag a reasonably large area. Very tiny selections will be ignored.
            </p>
        </div>
    </div>

    <form method="post" class="mt-3">
        {% csrf_token %}
        <input type="hidden" name="page_number" value="{{ page_number }}">
        <input type="hidden" id="input-x1" name="x1">
        <input type="hidden" id="input-y1" name="y1">
        <input type="hidden" id="input-x2" name="x2">
        <input type="hidden" id="input-y2" name="y2">

        <button type="submit" class="btn btn-primary" id="confirm-btn" disabled>
            Confirm Selection
        </button>
    </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
    const viewer = document.getElementById('viewer-container');
    const rectEl = document.getElementById('selection-rect');
    const confirmBtn = document.getElementById('confirm-btn');

    const inputX1 = document.getElementById('input-x1');
    const inputY1 = document.getElementById('input-y1');
    const inputX2 = document.getElementById('input-x2');
    const inputY2 = document.getElementById('input-y2');

    const coordX1 = document.getElementById('coord-x1');
    const coordY1 = document.getElementById('coord-y1');
    const coordX2 = document.getElementById('coord-x2');
    const coordY2 = document.getElementById('coord-y2');

    let isDrawing = false;
    let startX = 0, startY = 0, endX = 0, endY = 0;

    function updateRect() {
        const xMin = Math.min(startX, endX);
        const xMax = Math.max(startX, endX);
        const yMin = Math.min(startY, endY);
        const yMax = Math.max(startY, endY);

        rectEl.style.left = (xMin * 100) + '%';
        rectEl.style.top = (yMin * 100) + '%';
        rectEl.style.width = ((xMax - xMin) * 100) + '%';
        rectEl.style.height = ((yMax - yMin) * 100) + '%';
    }

    function saveSelection() {
        const xMin = Math.min(startX, endX);
        const xMax = Math.max(startX, endX);
        const yMin = Math.min(startY, endY);
        const yMax = Math.max(startY, endY);

     
        if ((xMax - xMin) < 0.01 || (yMax - yMin) < 0.01) {
            return;
        }

        inputX1.value = xMin.toFixed(4);
        inputY1.value = yMin.toFixed(4);
        inputX2.value = xMax.toFixed(4);
        inputY2.value = yMax.toFixed(4);

        coordX1.textContent = xMin.toFixed(3);
        coordY1.textContent = yMin.toFixed(3);
        coordX2.textContent = xMax.toFixed(3);
        coordY2.textContent = yMax.toFixed(3);

        confirmBtn.disabled = false;
    }

    viewer.addEventListener('mousedown', function (e) {
        const bounds = viewer.getBoundingClientRect();
        isDrawing = true;

        const relX = (e.clientX - bounds.left) / bounds.width;
        const relY = (e.clientY - bounds.top) / bounds.height;

        startX = Math.min(Math.max(relX, 0), 1);
        startY = Math.min(Math.max(relY, 0), 1);
        endX = startX;
        endY = startY;

        rectEl.classList.remove('d-none');
        updateRect();
    });

    viewer.addEventListener('mousemove', function (e) {
        if (!isDrawing) return;
        const bounds = viewer.getBoundingClientRect();
        const relX = (e.clientX - bounds.left) / bounds.width;
        const relY = (e.clientY - bounds.top) / bounds.height;

        endX = Math.min(Math.max(relX, 0), 1);
        endY = Math.min(Math.max(relY, 0), 1);
        updateRect();
    });

    viewer.addEventListener('mouseup', function () {
        if (!isDrawing) return;
        isDrawing = false;
        saveSelection();
    });

    viewer.addEventListener('mouseleave', function () {
        if (!isDrawing) return;
        isDrawing = false;
        saveSelection();
    });
});
</script>
{% endblock %}
